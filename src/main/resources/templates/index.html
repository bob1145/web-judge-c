<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C++ 在线对拍工具</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/dracula.min.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #6366f1;
            --primary-dark: #4f46e5;
            --secondary-color: #8b5cf6;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --info-color: #06b6d4;
            --dark-color: #1f2937;
            --light-color: #f8fafc;
            --border-color: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --gradient-primary: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }

        .main-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: var(--shadow-lg);
            margin: 2rem;
            padding: 2rem;
            min-height: calc(100vh - 4rem);
        }

        .header {
            text-align: center;
            margin-bottom: 3rem;
            position: relative;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 4px;
            background: var(--gradient-primary);
            border-radius: 2px;
        }

        .header h1 {
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .header p {
            color: #64748b;
            font-size: 1.1rem;
            margin: 0;
        }

        .settings-card {
            background: white;
            border-radius: 16px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            padding: 1.5rem;
            height: fit-content;
            position: sticky;
            top: 2rem;
        }

        .settings-card h4 {
            color: var(--dark-color);
            font-weight: 600;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-label {
            font-weight: 500;
            color: var(--dark-color);
            margin-bottom: 0.5rem;
        }

        .form-control {
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 0.75rem;
            transition: all 0.2s ease;
            font-size: 0.95rem;
        }

        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .btn-primary {
            background: var(--gradient-primary);
            border: none;
            border-radius: 10px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-sm);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--secondary-color) 100%);
        }

        .btn-primary:disabled {
            transform: none;
            opacity: 0.7;
        }

        .code-section {
            background: white;
            border-radius: 16px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .code-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .code-header h5 {
            color: var(--dark-color);
            font-weight: 600;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-upload {
            background: #f1f5f9;
            border: 1px solid var(--border-color);
            color: #64748b;
            border-radius: 8px;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }

        .btn-upload:hover {
            background: #e2e8f0;
            color: var(--dark-color);
        }

        .CodeMirror {
            border: 2px solid var(--border-color);
            border-radius: 12px;
            height: 320px;
            font-size: 14px;
            box-shadow: var(--shadow-sm);
        }

        .CodeMirror-focused {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .progress-section {
            background: white;
            border-radius: 16px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            padding: 1.5rem;
            margin-top: 1.5rem;
        }

        .progress {
            height: 14px;
            border-radius: 10px;
            background: #f1f5f9;
            overflow: hidden;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .progress-bar {
            background: var(--gradient-primary);
            border-radius: 10px;
            transition: none;
            /* 移除CSS过渡，使用JS控制 */
            position: relative;
            overflow: hidden;
        }

        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg,
                    transparent 0%,
                    rgba(255, 255, 255, 0.3) 50%,
                    transparent 100%);
            animation: progress-shine 2s infinite;
        }

        @keyframes progress-shine {
            0% {
                transform: translateX(-100%);
            }

            100% {
                transform: translateX(100%);
            }
        }

        .progress-bar.progress-bar-animated::after {
            animation: progress-shine 1.5s infinite;
        }

        .results-section {
            background: white;
            border-radius: 16px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            padding: 1.5rem;
            margin-top: 2rem;
        }

        .results-section h4 {
            color: var(--dark-color);
            font-weight: 600;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            gap: 12px;
            margin-top: 1rem;
        }

        .result-case {
            cursor: pointer;
            border-radius: 12px;
            padding: 12px 8px;
            text-align: center;
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-sm);
            position: relative;
            overflow: hidden;
        }

        .result-case::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .result-case:hover::before {
            left: 100%;
        }

        .result-case:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
        }

        .case-number {
            font-size: 0.75rem;
            display: block;
            opacity: 0.9;
            margin-bottom: 2px;
        }

        .case-status {
            font-size: 1rem;
            font-weight: 700;
        }

        .case-details {
            font-size: 0.7rem;
            display: block;
            margin-top: 2px;
            opacity: 0.8;
        }

        .status-ac {
            background: linear-gradient(135deg, var(--success-color), #059669);
        }

        .status-wa {
            background: linear-gradient(135deg, var(--danger-color), #dc2626);
        }

        .status-tle {
            background: linear-gradient(135deg, var(--warning-color), #d97706);
        }

        .status-re {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        }

        .status-ce {
            background: linear-gradient(135deg, var(--info-color), #0891b2);
        }

        .status-se,
        .status-system-error {
            background: linear-gradient(135deg, #6b7280, #4b5563);
        }

        .modal-content {
            border-radius: 16px;
            border: none;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            background: var(--gradient-primary);
            color: white;
            border-radius: 16px 16px 0 0;
            border-bottom: none;
        }

        .modal-title {
            font-weight: 600;
        }

        .btn-close {
            filter: invert(1);
        }

        .modal-body {
            padding: 2rem;
        }

        .modal-footer {
            border-top: 1px solid var(--border-color);
            padding: 1rem 2rem;
        }

        pre {
            background: #f8fafc;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            font-size: 0.875rem;
            max-height: 300px;
            overflow-y: auto;
        }

        .alert {
            border-radius: 12px;
            border: none;
            box-shadow: var(--shadow-sm);
        }

        .spinner-border {
            color: var(--primary-color);
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }

        .btn-outline-secondary {
            border: 2px solid var(--border-color);
            color: #64748b;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .btn-outline-secondary:hover {
            background: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
            transform: translateY(-1px);
        }

        .btn-outline-info {
            border: 2px solid var(--info-color);
            color: var(--info-color);
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .btn-outline-info:hover {
            background: var(--info-color);
            border-color: var(--info-color);
            color: white;
            transform: translateY(-1px);
        }

        .solution-card {
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .solution-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }

        .toast {
            border-radius: 12px;
            border: none;
            box-shadow: var(--shadow-lg);
        }

        @media (max-width: 768px) {
            .main-container {
                margin: 1rem;
                padding: 1rem;
            }

            .header h1 {
                font-size: 2rem;
            }

            .results-grid {
                grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
                gap: 8px;
            }

            .result-case {
                padding: 8px 4px;
            }
        }
    </style>
</head>

<body>
    <div class="main-container">
        <div class="header">
            <h1><i class="fas fa-code"></i> C++ 在线对拍工具</h1>
            <p>高效、准确、实时的算法代码测试平台</p>
        </div>

        <div class="row">
            <div class="col-lg-3">
                <div class="settings-card">
                    <h4><i class="fas fa-cog"></i> 判题设置</h4>
                    <form id="judge-form">
                        <div class="mb-3">
                            <label for="test-cases" class="form-label">
                                <i class="fas fa-list-ol"></i> 测试点数量
                            </label>
                            <input type="number" class="form-control" id="test-cases" value="100" min="1" max="50000">
                        </div>
                        <div class="mb-3">
                            <label for="time-limit" class="form-label">
                                <i class="fas fa-clock"></i> 时间限制 (ms)
                            </label>
                            <input type="number" class="form-control" id="time-limit" value="1000" min="100"
                                max="10000">
                        </div>
                        <div class="mb-3">
                            <label for="precision" class="form-label">
                                <i class="fas fa-calculator"></i> 浮点数精度
                            </label>
                            <input type="text" class="form-control" id="precision" value="1e-9" placeholder="例: 1e-9">
                        </div>
                        <button type="submit" id="start-button" class="btn btn-primary w-100 mb-2">
                            <i class="fas fa-play"></i> 开始对拍
                        </button>
                        <button type="button" class="btn btn-outline-secondary w-100 mb-2" onclick="loadExample()">
                            <i class="fas fa-lightbulb"></i> 加载示例代码
                        </button>
                        <button type="button" class="btn btn-outline-info w-100" onclick="showRandomSolutionDialog()">
                            <i class="fas fa-dice"></i> 随机数方案
                        </button>
                    </form>

                    <div id="progress-container" class="progress-section" style="display: none;">
                        <h4><i class="fas fa-chart-line"></i> 判题状态</h4>
                        <div class="progress">
                            <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated"
                                role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0"
                                aria-valuemax="100">
                            </div>
                        </div>
                        <div id="result-summary" class="mt-3 text-center text-muted"></div>
                    </div>
                </div>
            </div>

            <div class="col-lg-9">
                <div class="code-section fade-in">
                    <div class="code-header">
                        <h5><i class="fas fa-random"></i> 生成器代码 (Generator)</h5>
                        <input type="file" class="d-none" id="generator-file" accept=".cpp,.c,.txt">
                        <button class="btn-upload" onclick="document.getElementById('generator-file').click();">
                            <i class="fas fa-upload"></i> 上传文件
                        </button>
                    </div>
                    <textarea id="generator-code" class="form-control code-textarea"></textarea>
                </div>

                <div class="code-section fade-in">
                    <div class="code-header">
                        <h5><i class="fas fa-shield-alt"></i> 暴力/正确代码 (Brute Force)</h5>
                        <input type="file" class="d-none" id="brute-force-file" accept=".cpp,.c,.txt">
                        <button class="btn-upload" onclick="document.getElementById('brute-force-file').click();">
                            <i class="fas fa-upload"></i> 上传文件
                        </button>
                    </div>
                    <textarea id="brute-force-code" class="form-control code-textarea"></textarea>
                </div>

                <div class="code-section fade-in">
                    <div class="code-header">
                        <h5><i class="fas fa-user-edit"></i> 待测试代码 (My Solution)</h5>
                        <input type="file" class="d-none" id="user-code-file" accept=".cpp,.c,.txt">
                        <button class="btn-upload" onclick="document.getElementById('user-code-file').click();">
                            <i class="fas fa-upload"></i> 上传文件
                        </button>
                    </div>
                    <textarea id="user-code" class="form-control code-textarea"></textarea>
                </div>
            </div>
        </div>

        <div class="results-section fade-in">
            <h4><i class="fas fa-chart-bar"></i> 测试点详情</h4>
            <div id="results-grid" class="results-grid">
                <div class="text-center text-muted py-4">
                    <i class="fas fa-info-circle fa-2x mb-2"></i>
                    <p>点击"开始对拍"按钮开始测试，结果将在这里显示</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Details Modal -->
    <div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="detailsModalLabel">
                        <i class="fas fa-search"></i> 测试点详情
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="modal-body-content">
                        <div class="text-center py-4">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2 text-muted">正在加载测试点详情...</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <a href="#" id="download-input-btn" class="btn btn-success" download>
                        <i class="fas fa-download"></i> 下载输入数据
                    </a>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> 关闭
                    </button>
                </div>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsdiff/5.1.0/diff.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/clike/clike.min.js"></script>
    <script src="/examples.js"></script>

    <script>
        const form = document.getElementById('judge-form');
        const startButton = document.getElementById('start-button');
        const progressBar = document.getElementById('progress-bar');
        const progressContainer = document.getElementById('progress-container');
        const resultSummary = document.getElementById('result-summary');
        const resultsGrid = document.getElementById('results-grid');
        const detailsModal = new bootstrap.Modal(document.getElementById('detailsModal'));
        const modalBodyContent = document.getElementById('modal-body-content');
        const detailsModalLabel = document.getElementById('detailsModalLabel');
        const downloadInputBtn = document.getElementById('download-input-btn');

        // Toast elements
        const successToast = new bootstrap.Toast(document.getElementById('success-toast'));
        const errorToast = new bootstrap.Toast(document.getElementById('error-toast'));
        const successMessage = document.getElementById('success-message');
        const errorMessage = document.getElementById('error-message');

        let stompClient = null;
        let currentJudgeId = null;

        // --- CodeMirror Setup ---
        const editorSettings = {
            mode: "text/x-c++src",
            theme: "dracula",
            lineNumbers: true,
            matchBrackets: true,
            indentUnit: 4,
        };

        const generatorEditor = CodeMirror.fromTextArea(document.getElementById('generator-code'), editorSettings);
        const bruteForceEditor = CodeMirror.fromTextArea(document.getElementById('brute-force-code'), editorSettings);
        const userEditor = CodeMirror.fromTextArea(document.getElementById('user-code'), editorSettings);

        const editors = {
            'generator': generatorEditor,
            'brute-force': bruteForceEditor,
            'user': userEditor
        };

        // --- Local Storage ---
        function saveCode() {
            localStorage.setItem('generatorCode', generatorEditor.getValue());
            localStorage.setItem('bruteForceCode', bruteForceEditor.getValue());
            localStorage.setItem('userCode', userEditor.getValue());
        }

        function loadCode() {
            generatorEditor.setValue(localStorage.getItem('generatorCode') || '');
            bruteForceEditor.setValue(localStorage.getItem('bruteForceCode') || '');
            userEditor.setValue(localStorage.getItem('userCode') || '');
        }

        generatorEditor.on('change', saveCode);
        bruteForceEditor.on('change', saveCode);
        userEditor.on('change', saveCode);

        window.addEventListener('load', () => {
            loadCode();
            // 添加页面加载动画
            document.querySelectorAll('.fade-in').forEach((el, index) => {
                el.style.animationDelay = `${index * 0.1}s`;
            });
        });

        // --- File Upload ---
        function setupFileUpload(fileInputId, editor) {
            document.getElementById(fileInputId).addEventListener('change', function (event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        editor.setValue(e.target.result);
                    };
                    reader.readAsText(file);
                }
            });
        }
        setupFileUpload('generator-file', generatorEditor);
        setupFileUpload('brute-force-file', bruteForceEditor);
        setupFileUpload('user-code-file', userEditor);

        form.addEventListener('submit', async function (event) {
            event.preventDefault();

            // 验证输入
            if (!generatorEditor.getValue().trim()) {
                showError('请输入生成器代码！');
                return;
            }
            if (!bruteForceEditor.getValue().trim()) {
                showError('请输入暴力/正确代码！');
                return;
            }
            if (!userEditor.getValue().trim()) {
                showError('请输入待测试代码！');
                return;
            }

            startButton.disabled = true;
            startButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 正在运行...';
            resultSummary.innerHTML = '';
            resultsGrid.innerHTML = `
            <div class="text-center text-muted py-4 pulse">
                <i class="fas fa-cog fa-spin fa-2x mb-2"></i>
                <p>正在处理判题请求，请稍候...</p>
            </div>
        `;
            progressContainer.style.display = 'block';

            // 重置进度条状态
            resetProgressBar();
            updateProgressBar(0, '准备中...');

            try {
                const judgeRequest = {
                    userCode: userEditor.getValue(),
                    generatorCode: generatorEditor.getValue(),
                    bruteForceCode: bruteForceEditor.getValue(),
                    timeLimit: parseInt(document.getElementById('time-limit').value, 10),
                    precision: parseFloat(document.getElementById('precision').value),
                    testCases: parseInt(document.getElementById('test-cases').value, 10)
                };

                const response = await fetch('/judge', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(judgeRequest)
                });

                if (!response.ok) {
                    throw new Error('服务器响应错误');
                }

                currentJudgeId = await response.text();
                // 先建立WebSocket连接，等待连接成功后再通知后端开始处理
                try {
                    await connectAndSubscribeAsync(currentJudgeId);
                } catch (wsError) {
                    console.error('WebSocket连接失败，使用轮询方式:', wsError);
                    // 如果WebSocket连接失败，直接启动判题并使用轮询方式获取进度
                    await fetch('/judge/start/' + currentJudgeId, { method: 'POST' });
                    startPollingProgress(currentJudgeId);
                }
            } catch (error) {
                console.error('提交判题请求失败:', error);
                showError('提交判题请求失败，请检查网络连接或稍后重试');
                startButton.disabled = false;
                startButton.innerHTML = '<i class="fas fa-play"></i> 开始对拍';
                progressContainer.style.display = 'none';
                resultsGrid.innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="fas fa-exclamation-triangle fa-2x mb-2 text-warning"></i>
                    <p>提交失败，请重试</p>
                </div>
            `;
            }
        });

        // 进度条状态管理 - 需要在函数定义之前声明
        let currentProgress = 0;
        let targetProgress = 0;
        let progressAnimationId = null;
        let lastProgressUpdate = 0;

        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;
        
        function connectAndSubscribe(judgeId) {
            const socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);
            
            stompClient.connect({}, function (frame) {
                console.log('WebSocket连接成功');
                reconnectAttempts = 0;
                stompClient.subscribe('/topic/progress/' + judgeId, function (message) {
                    try {
                        const progressData = JSON.parse(message.body);
                        throttledHandleProgress(progressData);
                    } catch (error) {
                        console.error('解析进度消息失败:', error);
                    }
                });
            }, function (error) {
                console.error('WebSocket连接失败:', error);
                if (reconnectAttempts < maxReconnectAttempts) {
                    reconnectAttempts++;
                    console.log(`尝试重连 (${reconnectAttempts}/${maxReconnectAttempts})...`);
                    setTimeout(() => connectAndSubscribe(judgeId), 3000 * reconnectAttempts);
                } else {
                    showError('连接失败次数过多，请刷新页面重试');
                }
            });
        }

        // 异步版本的连接函数，返回Promise
        function connectAndSubscribeAsync(judgeId) {
            return new Promise((resolve, reject) => {
                const socket = new SockJS('/ws');
                stompClient = Stomp.over(socket);
                
                stompClient.connect({}, function (frame) {
                    console.log('WebSocket连接成功');
                    reconnectAttempts = 0;
                    stompClient.subscribe('/topic/progress/' + judgeId, function (message) {
                        try {
                            const progressData = JSON.parse(message.body);
                            throttledHandleProgress(progressData);
                        } catch (error) {
                            console.error('解析进度消息失败:', error);
                        }
                    });
                    
                    // 连接成功后通知后端开始处理
                    fetch('/judge/start/' + judgeId, {
                        method: 'POST'
                    }).then(() => {
                        resolve();
                    }).catch(error => {
                        console.error('启动判题失败:', error);
                        reject(error);
                    });
                    
                }, function (error) {
                    console.error('WebSocket连接失败:', error);
                    if (reconnectAttempts < maxReconnectAttempts) {
                        reconnectAttempts++;
                        console.log(`尝试重连 (${reconnectAttempts}/${maxReconnectAttempts})...`);
                        setTimeout(() => {
                            connectAndSubscribeAsync(judgeId).then(resolve).catch(reject);
                        }, 3000 * reconnectAttempts);
                    } else {
                        showError('连接失败次数过多，请刷新页面重试');
                        reject(error);
                    }
                });
            });
        }

        function smoothProgressUpdate() {
            if (!progressBar) {
                progressAnimationId = null;
                return;
            }

            const now = Date.now();
            const timeDiff = now - lastProgressUpdate;
            lastProgressUpdate = now;

            // 计算平滑步长，避免跳跃
            const maxStep = Math.max(0.5, timeDiff / 50); // 根据时间差调整步长
            const diff = targetProgress - currentProgress;

            if (Math.abs(diff) < 0.1) {
                currentProgress = targetProgress;
                updateProgressBarDirect(currentProgress);
                progressAnimationId = null;
                return;
            }

            // 平滑过渡
            const step = Math.sign(diff) * Math.min(Math.abs(diff), maxStep);
            currentProgress += step;

            updateProgressBarDirect(currentProgress);

            // 继续动画
            progressAnimationId = requestAnimationFrame(smoothProgressUpdate);
        }

        function updateProgressBar(percent, text) {
            // 确保进度值在合理范围内
            if (typeof percent !== 'number' || isNaN(percent)) {
                percent = 0;
            }
            percent = Math.max(0, Math.min(100, percent));

            // 设置目标进度
            targetProgress = percent;

            // 更新文本（立即更新）
            if (progressBar) {
                progressBar.innerText = text || '';
            }

            // 如果没有正在进行的动画，启动平滑更新
            if (progressAnimationId === null && progressBar) {
                lastProgressUpdate = Date.now();
                progressAnimationId = requestAnimationFrame(smoothProgressUpdate);
            }
        }

        function updateProgressBarDirect(percent) {
            if (!progressBar) return;

            // 确保百分比值有效
            if (typeof percent !== 'number' || isNaN(percent)) {
                percent = 0;
            }
            percent = Math.max(0, Math.min(100, percent));

            progressBar.style.width = percent + '%';
            progressBar.setAttribute('aria-valuenow', percent);
        }

        function resetProgressBar() {
            // 停止任何正在进行的动画
            if (progressAnimationId) {
                cancelAnimationFrame(progressAnimationId);
                progressAnimationId = null;
            }

            // 重置所有状态变量
            currentProgress = 0;
            targetProgress = 0;
            lastProgressUpdate = 0;

            // 重置进度条样式
            if (progressBar) {
                progressBar.style.width = '0%';
                progressBar.setAttribute('aria-valuenow', 0);
                progressBar.innerText = '';
                progressBar.style.background = 'var(--gradient-primary)';
                progressBar.classList.add('progress-bar-animated');
            }
        }

        // 改进的节流函数，专门用于进度更新
        function createProgressThrottle(func, limit) {
            let lastCall = 0;
            let timeoutId = null;

            return function (...args) {
                const now = Date.now();

                // 如果距离上次调用时间足够长，立即执行
                if (now - lastCall >= limit) {
                    lastCall = now;
                    func.apply(this, args);
                } else {
                    // 否则延迟执行，但要取消之前的延迟
                    clearTimeout(timeoutId);
                    timeoutId = setTimeout(() => {
                        lastCall = Date.now();
                        func.apply(this, args);
                    }, limit - (now - lastCall));
                }
            };
        }

        function handleProgress(progress) {
            console.log("Received progress:", progress);

            // 验证进度数据的有效性
            if (!progress || typeof progress !== 'object') {
                console.error('Invalid progress data:', progress);
                return;
            }

            const { status, message, progress: percent, results } = progress;

            // 更新进度条和状态文本
            const totalTestCases = parseInt(document.getElementById('test-cases').value, 10);
            let displayText = message || status;

            // 如果是运行阶段且有进度百分比，显示更详细的信息
            if (status === 'RUNNING' && percent > 0 && totalTestCases > 100) {
                const completedCases = Math.floor((percent / 100) * totalTestCases);
                displayText = `${message || status} (${completedCases}/${totalTestCases})`;
            }

            updateProgressBar(percent, displayText);
            resultSummary.textContent = displayText;

            if (results) { // Final result with all test cases
                // 停止进度条动画
                if (progressAnimationId) {
                    cancelAnimationFrame(progressAnimationId);
                    progressAnimationId = null;
                }

                // 确保进度条到达100%
                currentProgress = 100;
                targetProgress = 100;
                updateProgressBarDirect(100);

                renderResultGrid(results);
                if (stompClient) {
                    stompClient.disconnect();
                }
                startButton.disabled = false;
                startButton.innerHTML = '<i class="fas fa-play"></i> 开始对拍';
                progressBar.classList.remove('progress-bar-animated');

                // 添加完成动画效果
                progressBar.style.background = 'linear-gradient(135deg, var(--success-color), #059669)';
                setTimeout(() => {
                    progressBar.style.background = 'var(--gradient-primary)';
                }, 2000);

                // 显示完成通知
                const totalTests = results.length;
                const acCount = results.filter(r => r.status === 'AC').length;
                const acRate = ((acCount / totalTests) * 100).toFixed(1);
                showSuccess(`判题完成！通过率: ${acRate}% (${acCount}/${totalTests})`);
            } else {
                if (!progressBar.classList.contains('progress-bar-animated')) {
                    progressBar.classList.add('progress-bar-animated');
                }
            }
        }

        // 使用更长的节流时间，减少大量测试用例时的更新频率
        const throttledHandleProgress = createProgressThrottle(handleProgress, 300);

        function escapeHtml(str) {
            if (str === null || str === undefined) {
                return '';
            }
            return str.toString()
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        function renderResultGrid(results) {
            resultsGrid.innerHTML = '';

            // 统计结果
            const stats = {
                AC: 0, WA: 0, TLE: 0, RE: 0, CE: 0, SE: 0
            };

            results.forEach(result => {
                const caseDiv = document.createElement('div');
                const statusClass = 'status-' + result.status.toLowerCase().replace(/_/g, '-');
                caseDiv.className = `result-case ${statusClass} fade-in`;

                // 统计
                if (stats.hasOwnProperty(result.status)) {
                    stats[result.status]++;
                }

                let detailsHtml = '';
                let statusIcon = '';

                switch (result.status) {
                    case 'AC':
                        detailsHtml = `<span class="case-details">${result.timeUsed} ms</span>`;
                        statusIcon = '<i class="fas fa-check"></i>';
                        break;
                    case 'WA':
                        statusIcon = '<i class="fas fa-times"></i>';
                        break;
                    case 'TLE':
                        statusIcon = '<i class="fas fa-clock"></i>';
                        break;
                    case 'RE':
                        statusIcon = '<i class="fas fa-exclamation"></i>';
                        break;
                    case 'CE':
                        statusIcon = '<i class="fas fa-code"></i>';
                        break;
                    default:
                        statusIcon = '<i class="fas fa-question"></i>';
                }

                caseDiv.innerHTML = `
                <span class="case-number">#${result.caseNumber}</span>
                <span class="case-status">${statusIcon} ${result.status}</span>
                ${detailsHtml}
            `;

                caseDiv.addEventListener('click', () => showDetailsModal(result));
                resultsGrid.appendChild(caseDiv);
            });

            // 显示统计信息
            const totalTests = results.length;
            const acRate = ((stats.AC / totalTests) * 100).toFixed(1);

            resultSummary.innerHTML = `
            <div class="mt-3 p-3 bg-light rounded">
                <strong>测试完成!</strong> 
                通过率: <span class="text-success">${acRate}%</span> 
                (${stats.AC}/${totalTests})
                ${stats.WA > 0 ? `<span class="text-danger ms-2">WA: ${stats.WA}</span>` : ''}
                ${stats.TLE > 0 ? `<span class="text-warning ms-2">TLE: ${stats.TLE}</span>` : ''}
                ${stats.RE > 0 ? `<span class="text-info ms-2">RE: ${stats.RE}</span>` : ''}
            </div>
        `;
        }

        async function showDetailsModal(result) {
            const { caseNumber, status, timeUsed } = result;

            let title = `测试点 #${caseNumber} - ${status}`;
            if (status === 'AC') {
                title += ` ( ${timeUsed} ms )`;
            }
            detailsModalLabel.textContent = title;

            downloadInputBtn.href = `/download/${currentJudgeId}/${caseNumber}`;

            modalBodyContent.innerHTML = `<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>`;
            detailsModal.show();

            try {
                const response = await fetch(`/details/${currentJudgeId}/${caseNumber}`);
                if (!response.ok) {
                    modalBodyContent.innerHTML = `<div class="alert alert-danger">无法加载测试点详情。</div>`;
                    return;
                }
                const details = await response.json();

                if (status === 'WA') {
                    const diffString = Diff.createTwoFilesPatch(
                        'expected.txt',
                        'user.txt',
                        details.correctOutput || '',
                        details.userOutput || '',
                        '标准输出',
                        '你的输出',
                        { context: 100 }
                    );

                    modalBodyContent.innerHTML = `
                    <h5>输入数据</h5>
                    <pre><code>${escapeHtml(details.input)}</code></pre>
                    <div id="diff-container"></div>
                `;

                    const diff2htmlUi = new Diff2HtmlUI(document.getElementById('diff-container'), diffString, {
                        drawFileList: false,
                        matching: 'none',
                        outputFormat: 'side-by-side'
                    });
                    diff2htmlUi.draw();

                } else {
                    modalBodyContent.innerHTML = `
                    <h5>输入数据</h5>
                    <pre><code>${escapeHtml(details.input)}</code></pre>
                    <h5>你的输出</h5>
                    <pre><code>${escapeHtml(details.userOutput || '')}</code></pre>
                    <h5>标准输出</h5>
                    <pre><code>${escapeHtml(details.correctOutput || '')}</code></pre>
                `;
                }
            } catch (error) {
                console.error('Failed to fetch details:', error);
                modalBodyContent.innerHTML = `<div class="alert alert-danger">加载详情时发生网络错误。</div>`;
            }
        }

        // Toast 通知函数
        function showSuccess(message) {
            if (successMessage && successToast) {
                successMessage.textContent = message;
                successToast.show();
            }
        }

        function showError(message) {
            if (errorMessage && errorToast) {
                errorMessage.textContent = message;
                errorToast.show();
            }
        }

        // 调试函数：测试进度条
        function testProgressBar() {
            console.log('Testing progress bar...');
            resetProgressBar();
            progressContainer.style.display = 'block';

            let testProgress = 0;
            const testInterval = setInterval(() => {
                testProgress += 10;
                updateProgressBar(testProgress, `测试进度 ${testProgress}%`);

                if (testProgress >= 100) {
                    clearInterval(testInterval);
                    setTimeout(() => {
                        progressContainer.style.display = 'none';
                        resetProgressBar();
                    }, 1000);
                }
            }, 200);
        }

        // 轮询备用方案，当WebSocket连接失败时使用
        function startPollingProgress(judgeId) {
            const pollInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/judge/status/${judgeId}`);
                    if (response.ok) {
                        const progressData = await response.json();
                        handleProgress(progressData);
                        
                        // 如果判题完成，停止轮询
                        if (progressData.results || progressData.status === 'SYSTEM_ERROR' || progressData.status === 'COMPILATION_ERROR') {
                            clearInterval(pollInterval);
                        }
                    }
                } catch (error) {
                    console.error('轮询进度失败:', error);
                }
            }, 1000); // 每秒轮询一次
        }

        // 在控制台中可以调用 testProgressBar() 来测试进度条
    </script>

    <!-- Toast Container -->
    <div class="toast-container">
        <div id="success-toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header bg-success text-white">
                <i class="fas fa-check-circle me-2"></i>
                <strong class="me-auto">成功</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="success-message"></div>
        </div>

        <div id="error-toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header bg-danger text-white">
                <i class="fas fa-exclamation-circle me-2"></i>
                <strong class="me-auto">错误</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="error-message"></div>
        </div>
    </div>

</body>

</html>